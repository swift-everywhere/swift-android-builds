name: buildbot
on:
  workflow_dispatch:
  push:
jobs:
  buildbot:
    runs-on: ubuntu-24.04
    steps:
      - name: Setup Toolchain
        id: setup-toolchain
        uses: skiptools/swift-android-action@main
        with:
          # just set up the toolchain and don't build anything
          build-package: false

      - name: Build packages
        shell: bash
        run: |
          #set -x
          set -o pipefail
          # random selection of the swiftpackageindex repositories
          for REPO in $(curl https://raw.githubusercontent.com/SwiftPackageIndex/PackageList/refs/heads/main/packages.json | jq -r '.[]' | sort -R | head -n 100) ; do
            DIR=$(echo "${REPO}" | cut -f 4- -d '/' | sed 's;.git$;;g')
            echo "Building: ${REPO} (https://swiftpackageindex.com/${DIR})"

            (git clone "${REPO}" "${DIR}" && ${{ steps.setup-toolchain.outputs.swift-build }} -c debug --package-path "${DIR}") | tee "${DIR}"/buildlog.txt && echo "SUCCESS: ${REPO}" || echo "FAILED: ${REPO}"
          done

